<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrazyGames - Î¨¥Î£å Ïò®ÎùºÏù∏ Í≤åÏûÑ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0d1117;
            color: #ffffff;
        }

        /* Ìó§Îçî */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: #161b22;
            border-bottom: 1px solid #30363d;
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
        }

        .menu-toggle {
            width: 40px;
            height: 40px;
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .menu-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 15px;
            cursor: pointer;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
        }

        .search-container {
            flex: 1;
            max-width: 500px;
            margin: 0 30px;
            position: relative;
        }

        .search-input {
            width: 100%;
            height: 44px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 22px;
            padding: 0 45px 0 20px;
            color: white;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #7c3aed;
        }

        .search-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #8b949e;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            margin-left: auto;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-login {
            padding: 10px 20px;
            background: #7c3aed;
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-login:hover {
            background: #6d28d9;
        }

        /* ÏÇ¨Ïù¥ÎìúÎ∞î */
        .sidebar {
            position: fixed;
            left: 0;
            top: 64px;
            width: 60px;
            height: calc(100vh - 64px);
            background: #161b22;
            border-right: 1px solid #30363d;
            display: flex;
            flex-direction: column;
            padding: 10px 0;
            overflow-y: auto;
            z-index: 900;
        }

        .sidebar::-webkit-scrollbar {
            width: 4px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 2px;
        }

        .sidebar-item {
            width: 60px;
            height: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #8b949e;
            font-size: 24px;
            position: relative;
            transition: all 0.2s;
        }

        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .sidebar-item.active {
            color: #7c3aed;
        }

        .sidebar-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 10px;
            bottom: 10px;
            width: 3px;
            background: #7c3aed;
            border-radius: 0 2px 2px 0;
        }

        /* Î©îÏù∏ Ïª®ÌÖêÏ∏† */
        .main-content {
            margin-left: 60px;
            margin-top: 64px;
            padding: 30px 40px;
        }

        .breadcrumb {
            color: #8b949e;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .page-title {
            font-size: 40px;
            font-weight: 800;
            margin-bottom: 12px;
        }

        .page-description {
            color: #8b949e;
            font-size: 15px;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
        }

        .dropdown {
            position: relative;
        }

        .dropdown-btn {
            padding: 10px 16px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dropdown-btn:hover {
            background: #21262d;
        }

        /* Í≤åÏûÑ Í∑∏Î¶¨Îìú */
        .games-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 16px;
            margin-bottom: 40px;
        }

        .game-card {
            background: #161b22;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #30363d;
        }

        .game-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            border-color: #7c3aed;
        }

        .game-thumb-wrapper {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            background: linear-gradient(135deg, #7c3aed, #a855f7);
        }

        .game-thumb {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .game-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #dc2626;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .game-badge.new {
            background: #7c3aed;
        }

        .game-info {
            padding: 12px;
        }

        .game-title {
            font-size: 14px;
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 6px;
        }

        .game-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #8b949e;
        }

        /* Î™®Îã¨ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #161b22;
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #30363d;
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
        }

        .close-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 12px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: #7c3aed;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #7c3aed;
            color: white;
        }

        .btn-primary:hover {
            background: #6d28d9;
        }

        .btn-secondary {
            background: #21262d;
            color: white;
        }

        .btn-secondary:hover {
            background: #30363d;
        }

        .game-iframe {
            width: 100%;
            height: 500px;
            border: none;
            border-radius: 12px;
            background: white;
            margin-bottom: 20px;
        }

        .game-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #8b949e;
        }

        .notification {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #161b22;
            border: 1px solid #7c3aed;
            border-radius: 12px;
            padding: 16px 24px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            z-index: 3000;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .notification.hide {
            animation: slideDown 0.3s ease forwards;
        }

        @keyframes slideDown {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(100px); opacity: 0; }
        }

        .create-game-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: #7c3aed;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(124, 58, 237, 0.4);
            z-index: 100;
            display: none;
        }

        .create-game-btn:hover {
            background: #6d28d9;
            transform: scale(1.1);
        }

        .profile-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        @media (max-width: 1400px) {
            .games-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        @media (max-width: 1100px) {
            .games-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 800px) {
            .games-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 600px) {
            .games-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Ìó§Îçî -->
    <header>
        <button class="menu-toggle">‚ò∞</button>
        
        <div class="logo" onclick="location.reload()">
            <div class="logo-icon">üéÆ</div>
            <div class="logo-text">
                <span style="color: white;">crazy</span><span style="color: #7c3aed;">games</span>
            </div>
        </div>

        <div class="search-container">
            <input type="text" class="search-input" id="searchInput" placeholder="Search">
            <span class="search-icon">üîç</span>
        </div>

        <div class="header-actions">
            <button class="icon-btn" onclick="openDM()" title="Messages">üí¨</button>
            <button class="icon-btn" onclick="openNotifications()" title="Notifications" id="notificationBtn">üîî</button>
            <button class="icon-btn" onclick="openUserSearch()" title="Search Users">üë§</button>
            <button class="icon-btn" onclick="navigateToSection('favorites')" title="Favorites">üíñ</button>
            <button class="btn-login" id="headerBtn" onclick="openModal('loginModal')">Log in</button>
        </div>
    </header>

    <!-- ÏÇ¨Ïù¥ÎìúÎ∞î -->
    <aside class="sidebar">
        <div class="sidebar-item active" data-section="home" title="Home">üè†</div>
        <div class="sidebar-item" data-section="new" title="New">‚ú®</div>
        <div class="sidebar-item" data-section="trending" title="Trending">üî•</div>
        <div class="sidebar-item" data-section="action" title="Action">‚öîÔ∏è</div>
        <div class="sidebar-item" data-section="adventure" title="Adventure">üó∫Ô∏è</div>
        <div class="sidebar-item" data-section="puzzle" title="Puzzle">üß©</div>
        <div class="sidebar-item" data-section="racing" title="Racing">üèéÔ∏è</div>
        <div class="sidebar-item" data-section="sports" title="Sports">‚öΩ</div>
        <div class="sidebar-item" data-section="arcade" title="Arcade">üïπÔ∏è</div>
        <div class="sidebar-item" data-section="favorites" title="Favorites">üíñ</div>
        <div class="sidebar-item" data-section="my-games" title="My Games">üìÅ</div>
        <div class="sidebar-item" data-section="profile" title="Profile">üë§</div>
    </aside>

    <!-- Î©îÏù∏ Ïª®ÌÖêÏ∏† -->
    <main class="main-content" id="mainContent">
        <!-- Ìôà -->
        <div id="homeView">
            <div class="page-title">Welcome to CrazyGames</div>
            <div class="page-description">Play thousands of free online games: arcade games, puzzle games, funny games, sports games, shooting games, and more.</div>
            
            <div class="section-header">
                <h2 class="section-title">All Games</h2>
                <div class="dropdown">
                    <button class="dropdown-btn">Top games ‚ñº</button>
                </div>
            </div>
            <div class="games-grid" id="allGames"></div>
        </div>

        <!-- ÏÑπÏÖò Î∑∞ -->
        <div id="sectionView" style="display: none;">
            <div class="breadcrumb" id="breadcrumb">Action</div>
            <div class="page-title" id="sectionTitle">Action Games</div>
            <div class="page-description" id="sectionDescription">Play the best action games on CrazyGames.</div>
            
            <div class="section-header">
                <h2 class="section-title">Top games</h2>
            </div>
            <div class="games-grid" id="sectionGames"></div>
        </div>

        <!-- ÌîÑÎ°úÌïÑ -->
        <div id="profileView" style="display: none;">
            <div class="page-title">Profile</div>
            
            <div class="profile-card">
                <div class="profile-avatar" id="profileAvatar">üë§</div>
                <h2 id="profileUsername" style="font-size: 24px; margin-bottom: 10px;">User</h2>
                <p id="profileBio" style="color: #8b949e; margin-bottom: 20px;">No bio yet</p>
                
                <div style="display: flex; gap: 20px; justify-content: center; margin-bottom: 20px;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: 700;">0</div>
                        <div style="color: #8b949e; font-size: 12px;">Followers</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: 700;">0</div>
                        <div style="color: #8b949e; font-size: 12px;">Following</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: 700;" id="profileGameCount">0</div>
                        <div style="color: #8b949e; font-size: 12px;">Games</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-primary" onclick="openModal('editProfileModal')">Edit Profile</button>
                    <button class="btn btn-secondary" onclick="showFollowers()">Followers</button>
                    <button class="btn btn-secondary" onclick="showFollowing()">Following</button>
                    <button class="btn btn-secondary" onclick="showFriends()">Friends</button>
                </div>
            </div>

            <div class="section-header">
                <h2 class="section-title">My Games</h2>
            </div>
            <div class="games-grid" id="profileGames"></div>
        </div>
    </main>

    <!-- ÌîåÎ°úÌåÖ Î≤ÑÌäº -->
    <button class="create-game-btn" id="createBtn" onclick="openCreateGameModal()" title="Create Game">+</button>

    <!-- Î™®Îã¨Îì§ -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Log in</h2>
                <button class="close-btn" onclick="closeModal('loginModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="loginEmail" placeholder="email@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="Password">
                </div>
                <button class="btn btn-primary" onclick="login()" style="width: 100%; margin-bottom: 12px;">Log in</button>
                <button class="btn btn-secondary" onclick="switchModal('loginModal', 'signupModal')" style="width: 100%;">Sign up</button>
            </div>
        </div>
    </div>

    <div id="signupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Sign up</h2>
                <button class="close-btn" onclick="closeModal('signupModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="signupUsername" placeholder="Username">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="signupEmail" placeholder="email@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="signupPassword" placeholder="Password (min 6 chars)">
                </div>
                <button class="btn btn-primary" onclick="signup()" style="width: 100%;">Sign up</button>
            </div>
        </div>
    </div>

    <div id="gameModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="gameModalTitle">Create Game</h2>
                <button class="close-btn" onclick="closeModal('gameModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Game Title *</label>
                    <input type="text" class="form-input" id="gameTitle" placeholder="Awesome Game">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="gameDescription" placeholder="Game description" style="font-family: 'Inter', sans-serif;"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Thumbnail URL</label>
                    <input type="text" class="form-input" id="gameThumbnail" placeholder="https://example.com/image.png">
                </div>
                <div class="form-group">
                    <label class="form-label">Controls</label>
                    <input type="text" class="form-input" id="gameControls" placeholder="Arrow keys to move">
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="gameCategory">
                        <option value="action">Action</option>
                        <option value="adventure">Adventure</option>
                        <option value="puzzle">Puzzle</option>
                        <option value="racing">Racing</option>
                        <option value="sports">Sports</option>
                        <option value="arcade">Arcade</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Server URL (Optional - For Multiplayer)</label>
                    <input type="text" class="form-input" id="gameServerUrl" placeholder="ws://your-server.com:8765">
                    <p style="font-size: 12px; color: #8b949e; margin-top: 5px;">
                        WebSocket server URL for real-time multiplayer games
                    </p>
                </div>
                <div class="form-group">
                    <label class="form-label">HTML Code</label>
                    <textarea class="form-textarea" id="gameHtml" placeholder="<div>Game HTML</div>"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">CSS Code</label>
                    <textarea class="form-textarea" id="gameCss" placeholder="body { background: #000; }"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">JavaScript Code</label>
                    <textarea class="form-textarea" id="gameJs" placeholder="console.log('Game!');"></textarea>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-primary" onclick="saveGame()" style="flex: 1;">üíæ Save Game</button>
                    <button class="btn btn-secondary" onclick="previewGame()">üëÅÔ∏è Preview</button>
                </div>
            </div>
        </div>
    </div>

    <div id="playModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="playGameTitle">Game</h2>
                <button class="close-btn" onclick="closeModal('playModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <p id="playGameDescription" style="color: #8b949e; margin-bottom: 10px;"></p>
                <p id="playGameControls" style="color: #7c3aed; font-weight: 600; margin-bottom: 20px;"></p>
                
                <iframe id="gameFrame" class="game-iframe"></iframe>
                
                <div class="game-actions">
                    <button class="btn btn-primary" onclick="toggleHeart()">‚ù§Ô∏è <span id="heartCount">0</span></button>
                    <button class="btn btn-secondary" onclick="toggleFavorite()">‚≠ê Favorite</button>
                    <button class="btn btn-secondary" onclick="editCurrentGame()">‚úèÔ∏è Edit</button>
                    <button class="btn btn-secondary" onclick="deleteCurrentGame()">üóëÔ∏è Delete</button>
                    <button class="btn btn-secondary" onclick="shareGame()">üîó Share</button>
                </div>

                <div style="background: rgba(255, 255, 255, 0.03); border-radius: 12px; padding: 20px; margin-top: 20px;">
                    <h3 style="margin-bottom: 15px;">üí¨ Comments</h3>
                    <div class="form-group">
                        <textarea class="form-textarea" id="commentInput" placeholder="Write a comment..." style="min-height: 80px; font-family: 'Inter', sans-serif;"></textarea>
                        <button class="btn btn-primary" onclick="addComment()" style="margin-top: 10px;">Post Comment</button>
                    </div>
                    <div id="commentsList" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Profile</h2>
                <button class="close-btn" onclick="closeModal('editProfileModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="editUsername" placeholder="Username">
                </div>
                <div class="form-group">
                    <label class="form-label">Bio</label>
                    <textarea class="form-textarea" id="editBio" placeholder="Tell us about yourself" style="font-family: 'Inter', sans-serif;"></textarea>
                </div>
                <button class="btn btn-primary" onclick="updateProfile()" style="width: 100%;">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- ÌåîÎ°úÏõå Î™®Îã¨ -->
    <div id="followersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Followers</h2>
                <button class="close-btn" onclick="closeModal('followersModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="followersList"></div>
            </div>
        </div>
    </div>

    <!-- ÌåîÎ°úÏûâ Î™®Îã¨ -->
    <div id="followingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Following</h2>
                <button class="close-btn" onclick="closeModal('followingModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="followingList"></div>
            </div>
        </div>
    </div>

    <!-- ÏπúÍµ¨ Î™®Îã¨ -->
    <div id="friendsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Friends</h2>
                <button class="close-btn" onclick="closeModal('friendsModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <input type="text" class="form-input" id="friendSearchInput" placeholder="Search users...">
                </div>
                <div id="friendsList"></div>
            </div>
        </div>
    </div>

    <!-- DM Î™®Îã¨ -->
    <div id="dmModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; height: 600px; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h2 class="modal-title">Messages</h2>
                <button class="close-btn" onclick="closeModal('dmModal')">‚úï</button>
            </div>
            <div style="display: flex; flex: 1; overflow: hidden;">
                <!-- ÎåÄÌôî Î™©Î°ù -->
                <div style="width: 300px; border-right: 1px solid #30363d; overflow-y: auto;">
                    <div style="padding: 15px;">
                        <input type="text" class="form-input" id="dmSearchInput" placeholder="Search conversations..." style="margin-bottom: 15px;">
                    </div>
                    <div id="conversationsList"></div>
                </div>
                
                <!-- Î©îÏãúÏßÄ ÏòÅÏó≠ -->
                <div style="flex: 1; display: flex; flex-direction: column;">
                    <div id="dmHeader" style="padding: 20px; border-bottom: 1px solid #30363d; display: none;">
                        <h3 id="dmRecipientName" style="font-size: 18px; font-weight: 700;"></h3>
                    </div>
                    
                    <div id="messagesArea" style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px;">
                        <div style="text-align: center; color: #8b949e; padding: 100px 20px;">
                            Select a conversation to start messaging
                        </div>
                    </div>
                    
                    <div id="messageInputArea" style="padding: 20px; border-top: 1px solid #30363d; display: none;">
                        <div style="display: flex; gap: 10px;">
                            <input type="text" class="form-input" id="messageInput" placeholder="Type a message..." style="flex: 1;">
                            <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÏïåÎ¶º Î™®Îã¨ -->
    <div id="notificationsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Notifications</h2>
                <button class="close-btn" onclick="closeModal('notificationsModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="notificationsList"></div>
            </div>
        </div>
    </div>

    <!-- Ïú†Ï†Ä Í≤ÄÏÉâ Î™®Îã¨ -->
    <div id="userSearchModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Search Users</h2>
                <button class="close-btn" onclick="closeModal('userSearchModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <input type="text" class="form-input" id="userSearchInput" placeholder="Search by username...">
                </div>
                <div id="userSearchResults"></div>
            </div>
        </div>
    </div>

    <!-- Îã§Î•∏ Ïú†Ï†Ä ÌîÑÎ°úÌïÑ Î™®Îã¨ -->
    <div id="otherUserProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="otherUserProfileTitle">User Profile</h2>
                <button class="close-btn" onclick="closeModal('otherUserProfileModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, #7c3aed, #a855f7); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 40px;" id="otherUserAvatar">üë§</div>
                    <h2 id="otherUsername" style="font-size: 24px; margin-bottom: 10px;">User</h2>
                    <p id="otherUserBio" style="color: #8b949e; margin-bottom: 20px;">No bio</p>
                    
                    <div style="display: flex; gap: 20px; justify-content: center; margin-bottom: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 20px; font-weight: 700;" id="otherFollowerCount">0</div>
                            <div style="color: #8b949e; font-size: 12px;">Followers</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 20px; font-weight: 700;" id="otherFollowingCount">0</div>
                            <div style="color: #8b949e; font-size: 12px;">Following</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 20px; font-weight: 700;" id="otherGameCount">0</div>
                            <div style="color: #8b949e; font-size: 12px;">Games</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" id="followBtn" onclick="followUser()">Follow</button>
                        <button class="btn btn-secondary" id="friendBtn" onclick="sendFriendRequestToUser()">Add Friend</button>
                        <button class="btn btn-secondary" onclick="startDMWithUser()">Message</button>
                    </div>
                </div>
                
                <div class="section-header">
                    <h2 class="section-title">Games</h2>
                </div>
                <div class="games-grid" id="otherUserGames"></div>
            </div>
        </div>
    </div>

    <script>
        const sb = window.supabase.createClient(
            'https://alnazztrdhpkyclkaklv.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFsbmF6enRyZGhwa3ljbGtha2x2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3MzIwNDgsImV4cCI6MjA4NDMwODA0OH0.mUvc6zTV-xNhuBlC0iseVKX1WeNvkGgV_wO4Yl0dGxA'
        );

        let currentUser = null;
        let currentGame = null;
        let editingGameId = null;
        let allGames = [];

        const sectionInfo = {
            'home': { title: 'Welcome to CrazyGames', desc: 'Play thousands of free online games: arcade games, puzzle games, funny games, sports games, shooting games, and more.' },
            'new': { title: 'New Games', desc: 'The newest games on CrazyGames, released every day!' },
            'trending': { title: 'Trending Games', desc: 'The hottest and most popular games right now!' },
            'action': { title: 'Action Games', desc: 'Fast-paced action games with intense gameplay!' },
            'adventure': { title: 'Adventure Games', desc: 'Explore new worlds and embark on exciting adventures!' },
            'puzzle': { title: 'Puzzle Games', desc: 'Challenge your mind with brain-teasing puzzles!' },
            'racing': { title: 'Racing Games', desc: 'Speed thrills and racing excitement!' },
            'sports': { title: 'Sports Games', desc: 'Experience the thrill of sports competition!' },
            'arcade': { title: 'Arcade Games', desc: 'Classic arcade action and fun!' },
            'favorites': { title: 'Favorites', desc: 'Your favorite games in one place!' },
            'my-games': { title: 'My Games', desc: 'Games you created!' },
            'profile': { title: 'Profile', desc: '' }
        };

        async function init() {
            await checkAuth();
            await loadGames();
            setupEventListeners();
            
            // Î°úÍ∑∏Ïù∏Ìïú Í≤ΩÏö∞ ÏïåÎ¶º Ï£ºÍ∏∞Ï†ÅÏúºÎ°ú ÌôïÏù∏ (30Ï¥àÎßàÎã§)
            if (currentUser) {
                setInterval(async () => {
                    if (currentUser) {
                        await checkNewNotifications();
                    }
                }, 30000);
            }
        }

        async function checkNewNotifications() {
            if (!currentUser) return;

            const { data: friendRequests } = await sb
                .from('friendships')
                .select('id')
                .or(`user1_id.eq.${currentUser.id},user2_id.eq.${currentUser.id}`)
                .eq('status', 'pending');

            const myRequests = friendRequests?.filter(req => req.user2_id === currentUser.id) || [];
            
            const notifBtn = document.getElementById('notificationBtn');
            if (myRequests.length > 0) {
                notifBtn.style.position = 'relative';
                notifBtn.innerHTML = 'üîî<span style="position: absolute; top: 5px; right: 5px; width: 8px; height: 8px; background: #ef4444; border-radius: 50%;"></span>';
            } else {
                notifBtn.innerHTML = 'üîî';
            }
        }

        function setupEventListeners() {
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    navigateToSection(section);
                    
                    document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            document.getElementById('searchInput').addEventListener('input', (e) => {
                searchGames(e.target.value);
            });
        }

        function navigateToSection(section) {
            document.getElementById('homeView').style.display = 'none';
            document.getElementById('sectionView').style.display = 'none';
            document.getElementById('profileView').style.display = 'none';
            document.getElementById('createBtn').style.display = 'none';

            if (section === 'home') {
                document.getElementById('homeView').style.display = 'block';
                displayGames(allGames, 'allGames');
            } else if (section === 'profile') {
                if (!currentUser) {
                    showNotification('Please log in first!');
                    openModal('loginModal');
                    return;
                }
                document.getElementById('profileView').style.display = 'block';
            } else {
                showSectionView(section);
            }
        }

        function showSectionView(section) {
            document.getElementById('sectionView').style.display = 'block';
            
            const info = sectionInfo[section];
            document.getElementById('breadcrumb').textContent = info.title.split(' ')[0];
            document.getElementById('sectionTitle').textContent = info.title;
            document.getElementById('sectionDescription').textContent = info.desc;

            if (section === 'my-games') {
                if (!currentUser) {
                    showNotification('Please log in first!');
                    openModal('loginModal');
                    navigateToSection('home');
                    return;
                }
                document.getElementById('createBtn').style.display = 'block';
                const myGames = allGames.filter(g => g.user_id === currentUser.id);
                displayGames(myGames, 'sectionGames');
            } else if (section === 'new') {
                const newGames = allGames.filter(g => {
                    const date = new Date(g.created_at);
                    return (new Date() - date) < 7 * 24 * 60 * 60 * 1000;
                });
                displayGames(newGames, 'sectionGames');
            } else if (section === 'trending') {
                const trending = [...allGames].sort((a, b) => (b.hearts || 0) - (a.hearts || 0));
                displayGames(trending, 'sectionGames');
            } else if (section === 'favorites') {
                if (!currentUser) {
                    showNotification('Please log in first!');
                    openModal('loginModal');
                    navigateToSection('home');
                    return;
                }
                loadFavorites();
            } else {
                const filtered = allGames.filter(g => g.category === section);
                displayGames(filtered, 'sectionGames');
            }
        }

        async function loadFavorites() {
            const { data: favorites } = await sb.from('favorites').select('game_id').eq('user_id', currentUser.id);

            if (favorites) {
                const gameIds = favorites.map(f => f.game_id);
                if (gameIds.length > 0) {
                    const { data: games } = await sb.from('games').select('*').in('id', gameIds);
                    displayGames(games || [], 'sectionGames');
                } else {
                    displayGames([], 'sectionGames');
                }
            }
        }

        async function checkAuth() {
            const { data } = await sb.auth.getSession();
            if (data.session) {
                currentUser = data.session.user;
                updateHeader();
            }
        }

        function updateHeader() {
            if (currentUser) {
                document.getElementById('headerBtn').textContent = 'Log out';
                document.getElementById('headerBtn').onclick = logout;
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showNotification('Please enter email and password!');
                return;
            }

            const { data, error } = await sb.auth.signInWithPassword({ email, password });

            if (error) {
                showNotification('Login failed: ' + error.message);
            } else {
                currentUser = data.user;
                closeModal('loginModal');
                showNotification('Welcome! üéâ');
                updateHeader();
                await loadGames();
            }
        }

        async function signup() {
            const username = document.getElementById('signupUsername').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;

            if (!username || !email || !password) {
                showNotification('Please fill all fields!');
                return;
            }

            const { data, error } = await sb.auth.signUp({ email, password });

            if (error) {
                showNotification('Signup failed: ' + error.message);
            } else {
                await sb.from('profiles').insert([{ id: data.user.id, username: username, bio: '' }]);
                
                if (data.session) {
                    currentUser = data.user;
                    closeModal('signupModal');
                    showNotification('Welcome! üéâ');
                    updateHeader();
                    await loadGames();
                } else {
                    showNotification('Signup successful! Please log in.');
                    switchModal('signupModal', 'loginModal');
                }
            }
        }

        async function logout() {
            await sb.auth.signOut();
            currentUser = null;
            document.getElementById('headerBtn').textContent = 'Log in';
            document.getElementById('headerBtn').onclick = () => openModal('loginModal');
            showNotification('Logged out');
            navigateToSection('home');
        }

        async function loadGames() {
            const { data: games } = await sb.from('games').select('*').order('created_at', { ascending: false });

            if (games) {
                allGames = games;
                displayGames(games, 'allGames');

                if (currentUser) {
                    await loadUserProfile();
                    const myGames = games.filter(g => g.user_id === currentUser.id);
                    displayGames(myGames, 'profileGames');
                    
                    // ÏïåÎ¶º ÌôïÏù∏
                    await loadNotifications();
                }
            }
        }

        function displayGames(games, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (games.length === 0) {
                container.innerHTML = '<div class="empty-state"><p style="font-size: 60px; opacity: 0.3;">üéÆ</p><p>No games yet</p></div>';
                return;
            }

            // SVG placeholder Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ±
            const placeholderSVG = `data:image/svg+xml,%3Csvg width='320' height='180' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='320' height='180' fill='%237c3aed'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='24' fill='white'%3EGame%3C/text%3E%3C/svg%3E`;

            container.innerHTML = games.map(game => {
                const isNew = (() => {
                    const date = new Date(game.created_at);
                    return (new Date() - date) < 7 * 24 * 60 * 60 * 1000;
                })();
                
                const isHot = (game.hearts || 0) > 10;
                
                return `
                    <div class="game-card" onclick="playGame('${game.id}')">
                        <div class="game-thumb-wrapper">
                            <img src="${game.thumbnail_url || placeholderSVG}" 
                                 alt="${game.title}" 
                                 class="game-thumb"
                                 onerror="this.src='${placeholderSVG}'">
                            ${isHot ? '<div class="game-badge">TOP RATED</div>' : ''}
                            ${isNew && !isHot ? '<div class="game-badge new">NEW</div>' : ''}
                        </div>
                        <div class="game-info">
                            <div class="game-title">${game.title}</div>
                            <div class="game-meta">
                                <span>${getCategoryName(game.category)}</span>
                                <span>‚ù§Ô∏è ${game.hearts || 0}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getCategoryName(category) {
            const categories = {
                'action': 'Action', 'adventure': 'Adventure', 'puzzle': 'Puzzle',
                'racing': 'Racing', 'sports': 'Sports', 'arcade': 'Arcade'
            };
            return categories[category] || 'Game';
        }

        function openCreateGameModal() {
            if (!currentUser) {
                showNotification('Please log in first!');
                openModal('loginModal');
                return;
            }
            
            editingGameId = null;
            document.getElementById('gameModalTitle').textContent = 'Create Game';
            document.getElementById('gameTitle').value = '';
            document.getElementById('gameDescription').value = '';
            document.getElementById('gameThumbnail').value = '';
            document.getElementById('gameControls').value = '';
            document.getElementById('gameCategory').value = 'action';
            document.getElementById('gameHtml').value = '';
            document.getElementById('gameCss').value = '';
            document.getElementById('gameJs').value = '';
            openModal('gameModal');
        }

        async function saveGame() {
            if (!currentUser) {
                showNotification('Please log in first!');
                return;
            }

            const gameData = {
                title: document.getElementById('gameTitle').value,
                description: document.getElementById('gameDescription').value,
                thumbnail_url: document.getElementById('gameThumbnail').value,
                controls: document.getElementById('gameControls').value,
                category: document.getElementById('gameCategory').value,
                server_url: document.getElementById('gameServerUrl').value || null,
                html_code: document.getElementById('gameHtml').value,
                css_code: document.getElementById('gameCss').value,
                js_code: document.getElementById('gameJs').value,
                user_id: currentUser.id
            };

            if (!gameData.title) {
                showNotification('Please enter a title!');
                return;
            }

            let error;
            if (editingGameId) {
                ({ error } = await sb.from('games').update(gameData).eq('id', editingGameId));
            } else {
                ({ error } = await sb.from('games').insert([gameData]));
            }

            if (error) {
                showNotification('Save failed: ' + error.message);
                console.error('Save error:', error);
            } else {
                showNotification(editingGameId ? 'Game updated! ‚ú®' : 'Game created! üéâ');
                closeModal('gameModal');
                await loadGames();
                editingGameId = null;
            }
        }

        function previewGame() {
            const html = document.getElementById('gameHtml').value;
            const css = document.getElementById('gameCss').value;
            const js = document.getElementById('gameJs').value;

            const preview = window.open('', '_blank');
            preview.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8">
                <style>${css}</style></head><body>${html}<script>${js}<\/script></body></html>`);
        }

        async function playGame(gameId) {
            const { data: game } = await sb.from('games').select('*').eq('id', gameId).single();

            if (game) {
                currentGame = game;
                document.getElementById('playGameTitle').textContent = game.title;
                document.getElementById('playGameDescription').textContent = game.description || '';
                document.getElementById('playGameControls').textContent = 'üéÆ ' + (game.controls || 'No controls');
                document.getElementById('heartCount').textContent = game.hearts || 0;

                const iframe = document.getElementById('gameFrame');
                iframe.srcdoc = `<!DOCTYPE html><html><head><meta charset="UTF-8">
                    <style>body{margin:0;padding:20px;}${game.css_code||''}</style></head>
                    <body>${game.html_code||'<div style="text-align:center;padding:100px;"><h2>No game code</h2></div>'}
                    <script>${game.js_code||''}<\/script></body></html>`;
                
                openModal('playModal');
                await loadComments(gameId);
            }
        }

        function editCurrentGame() {
            if (!currentUser || !currentGame || currentGame.user_id !== currentUser.id) {
                showNotification('You can only edit your own games!');
                return;
            }

            editingGameId = currentGame.id;
            document.getElementById('gameModalTitle').textContent = 'Edit Game';
            document.getElementById('gameTitle').value = currentGame.title;
            document.getElementById('gameDescription').value = currentGame.description || '';
            document.getElementById('gameThumbnail').value = currentGame.thumbnail_url || '';
            document.getElementById('gameControls').value = currentGame.controls || '';
            document.getElementById('gameCategory').value = currentGame.category || 'action';
            document.getElementById('gameServerUrl').value = currentGame.server_url || '';
            document.getElementById('gameHtml').value = currentGame.html_code || '';
            document.getElementById('gameCss').value = currentGame.css_code || '';
            document.getElementById('gameJs').value = currentGame.js_code || '';
            openModal('gameModal');
        }

        async function deleteCurrentGame() {
            if (!currentUser || !currentGame || currentGame.user_id !== currentUser.id) {
                showNotification('You can only delete your own games!');
                return;
            }

            if (!confirm('Delete this game?')) return;

            const { error } = await sb.from('games').delete().eq('id', currentGame.id);

            if (!error) {
                showNotification('Game deleted');
                closeModal('playModal');
                await loadGames();
            }
        }

        async function toggleHeart() {
            if (!currentUser || !currentGame) {
                showNotification('Please log in first!');
                return;
            }

            const { data: existing } = await sb.from('hearts').select('*').eq('user_id', currentUser.id).eq('game_id', currentGame.id).single();

            if (existing) {
                await sb.from('hearts').delete().eq('id', existing.id);
                await sb.from('games').update({ hearts: (currentGame.hearts || 1) - 1 }).eq('id', currentGame.id);
                showNotification('Unliked');
            } else {
                await sb.from('hearts').insert([{ user_id: currentUser.id, game_id: currentGame.id }]);
                await sb.from('games').update({ hearts: (currentGame.hearts || 0) + 1 }).eq('id', currentGame.id);
                showNotification('Liked! ‚ù§Ô∏è');
            }

            await loadGames();
            document.getElementById('heartCount').textContent = (parseInt(document.getElementById('heartCount').textContent) + (existing ? -1 : 1));
        }

        async function toggleFavorite() {
            if (!currentUser || !currentGame) {
                showNotification('Please log in first!');
                return;
            }

            const { data: existing } = await sb.from('favorites').select('*').eq('user_id', currentUser.id).eq('game_id', currentGame.id).single();

            if (existing) {
                await sb.from('favorites').delete().eq('id', existing.id);
                showNotification('Removed from favorites');
            } else {
                await sb.from('favorites').insert([{ user_id: currentUser.id, game_id: currentGame.id }]);
                showNotification('Added to favorites! ‚≠ê');
            }
        }

        function shareGame() {
            if (!currentGame) return;
            
            const url = window.location.href.split('?')[0] + '?game=' + currentGame.id;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(url).then(() => {
                    showNotification('Link copied! üîó');
                });
            } else {
                showNotification('Share link: ' + url);
            }
        }

        async function loadComments(gameId) {
            const { data: comments } = await sb.from('comments').select('*, profiles(username)').eq('game_id', gameId).is('parent_id', null).order('created_at', { ascending: false });

            const commentsList = document.getElementById('commentsList');
            
            if (!comments || comments.length === 0) {
                commentsList.innerHTML = '<p style="color: #8b949e; text-align: center; padding: 20px;">Be the first to comment! üí¨</p>';
                return;
            }

            commentsList.innerHTML = comments.map(comment => `
                <div style="background: rgba(255, 255, 255, 0.03); border-radius: 10px; padding: 15px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 13px; color: #8b949e;">
                        <span style="color: #7c3aed; font-weight: 600;">${comment.profiles?.username || 'Unknown'}</span>
                        <span>${new Date(comment.created_at).toLocaleDateString()}</span>
                    </div>
                    <p>${comment.content}</p>
                </div>
            `).join('');
        }

        async function addComment() {
            if (!currentUser || !currentGame) {
                showNotification('Please log in first!');
                return;
            }

            const content = document.getElementById('commentInput').value;
            if (!content.trim()) {
                showNotification('Please enter a comment!');
                return;
            }

            const { error } = await sb.from('comments').insert([{
                game_id: currentGame.id,
                user_id: currentUser.id,
                content: content
            }]);

            if (!error) {
                document.getElementById('commentInput').value = '';
                await loadComments(currentGame.id);
                showNotification('Comment posted! üí¨');
            }
        }

        async function loadUserProfile() {
            if (!currentUser) return;

            const { data } = await sb.from('profiles').select('*').eq('id', currentUser.id).single();

            if (data) {
                document.getElementById('profileUsername').textContent = data.username;
                document.getElementById('profileBio').textContent = data.bio || 'No bio yet';
                document.getElementById('profileAvatar').textContent = data.username[0].toUpperCase();
            }

            // ÌåîÎ°úÏõå/ÌåîÎ°úÏûâ Ïàò Î°úÎìú
            await loadFollowStats();
            
            // Í≤åÏûÑ Ïàò
            const myGames = allGames.filter(g => g.user_id === currentUser.id);
            document.getElementById('profileGameCount').textContent = myGames.length;
        }

        async function loadFollowStats() {
            if (!currentUser) return;

            // ÌåîÎ°úÏõå Ïàò
            const { data: followers } = await sb
                .from('follows')
                .select('follower_id')
                .eq('following_id', currentUser.id);

            // ÌåîÎ°úÏûâ Ïàò
            const { data: following } = await sb
                .from('follows')
                .select('following_id')
                .eq('follower_id', currentUser.id);

            // UI ÏóÖÎç∞Ïù¥Ìä∏ - ÌîÑÎ°úÌïÑ Ïπ¥ÎìúÏùò ÌÜµÍ≥Ñ
            const profileCard = document.querySelector('.profile-card');
            if (profileCard) {
                const stats = profileCard.querySelectorAll('[style*="text-align: center"]');
                if (stats[0]) {
                    const followerCount = stats[0].querySelector('div:first-child');
                    if (followerCount) followerCount.textContent = followers?.length || 0;
                }
                if (stats[1]) {
                    const followingCount = stats[1].querySelector('div:first-child');
                    if (followingCount) followingCount.textContent = following?.length || 0;
                }
            }

            console.log('Follow stats updated:', {
                followers: followers?.length || 0,
                following: following?.length || 0
            });
        }

        async function showFollowers() {
            if (!currentUser) return;

            const { data: follows } = await sb
                .from('follows')
                .select('follower_id, profiles!follows_follower_id_fkey(username)')
                .eq('following_id', currentUser.id);

            const list = document.getElementById('followersList');
            
            if (!follows || follows.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #8b949e; padding: 40px;">No followers yet</p>';
            } else {
                list.innerHTML = follows.map(f => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 10px; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #7c3aed, #a855f7); display: flex; align-items: center; justify-content: center; font-size: 18px;">
                                ${f.profiles?.username?.[0]?.toUpperCase() || '?'}
                            </div>
                            <span style="font-weight: 600;">${f.profiles?.username || 'Unknown'}</span>
                        </div>
                        <button class="btn btn-secondary" onclick="toggleFollow('${f.follower_id}')">Follow Back</button>
                    </div>
                `).join('');
            }

            openModal('followersModal');
        }

        async function showFollowing() {
            if (!currentUser) return;

            const { data: follows } = await sb
                .from('follows')
                .select('following_id, profiles!follows_following_id_fkey(username)')
                .eq('follower_id', currentUser.id);

            const list = document.getElementById('followingList');
            
            if (!follows || follows.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #8b949e; padding: 40px;">Not following anyone yet</p>';
            } else {
                list.innerHTML = follows.map(f => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 10px; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #7c3aed, #a855f7); display: flex; align-items: center; justify-content: center; font-size: 18px;">
                                ${f.profiles?.username?.[0]?.toUpperCase() || '?'}
                            </div>
                            <span style="font-weight: 600;">${f.profiles?.username || 'Unknown'}</span>
                        </div>
                        <button class="btn btn-secondary" onclick="toggleFollow('${f.following_id}')">Unfollow</button>
                    </div>
                `).join('');
            }

            openModal('followingModal');
        }

        async function showFriends() {
            if (!currentUser) return;

            const { data: friendships } = await sb
                .from('friendships')
                .select('user1_id, user2_id, status')
                .or(`user1_id.eq.${currentUser.id},user2_id.eq.${currentUser.id}`)
                .eq('status', 'accepted');

            const list = document.getElementById('friendsList');
            
            if (!friendships || friendships.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #8b949e; padding: 40px;">No friends yet. Search for users above!</p>';
            } else {
                // ÏπúÍµ¨ ID Ï∂îÏ∂ú
                const friendIds = friendships.map(f => 
                    f.user1_id === currentUser.id ? f.user2_id : f.user1_id
                );

                // ÏπúÍµ¨ ÌîÑÎ°úÌïÑ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                const { data: profiles } = await sb
                    .from('profiles')
                    .select('id, username')
                    .in('id', friendIds);

                list.innerHTML = profiles.map(profile => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 10px; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #7c3aed, #a855f7); display: flex; align-items: center; justify-content: center; font-size: 18px;">
                                ${profile.username[0].toUpperCase()}
                            </div>
                            <span style="font-weight: 600;">${profile.username}</span>
                        </div>
                        <button class="btn btn-secondary" onclick="removeFriend('${profile.id}')">Remove</button>
                    </div>
                `).join('');
            }

            openModal('friendsModal');

            // Í≤ÄÏÉâ Í∏∞Îä•
            document.getElementById('friendSearchInput').addEventListener('input', async (e) => {
                const query = e.target.value.trim();
                if (query.length < 2) return;

                const { data: users } = await sb
                    .from('profiles')
                    .select('id, username')
                    .ilike('username', `%${query}%`)
                    .neq('id', currentUser.id)
                    .limit(10);

                if (users && users.length > 0) {
                    const searchResults = users.map(user => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(124, 58, 237, 0.1); border-radius: 10px; margin-bottom: 10px; border: 1px solid #7c3aed;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #7c3aed, #a855f7); display: flex; align-items: center; justify-content: center; font-size: 18px;">
                                    ${user.username[0].toUpperCase()}
                                </div>
                                <span style="font-weight: 600;">${user.username}</span>
                            </div>
                            <button class="btn btn-primary" onclick="sendFriendRequest('${user.id}')">Add Friend</button>
                        </div>
                    `).join('');
                    
                    list.innerHTML = searchResults + (list.innerHTML.includes('No friends yet') ? '' : list.innerHTML);
                }
            });
        }

        async function toggleFollow(userId) {
            if (!currentUser) return;

            // Ïù¥ÎØ∏ ÌåîÎ°úÏö∞ Ï§ëÏù∏ÏßÄ ÌôïÏù∏
            const { data: existing } = await sb
                .from('follows')
                .select('*')
                .eq('follower_id', currentUser.id)
                .eq('following_id', userId)
                .single();

            if (existing) {
                // Ïñ∏ÌåîÎ°úÏö∞
                await sb.from('follows').delete().eq('id', existing.id);
                showNotification('Unfollowed');
            } else {
                // ÌåîÎ°úÏö∞
                await sb.from('follows').insert([{
                    follower_id: currentUser.id,
                    following_id: userId
                }]);
                showNotification('Following! üë•');
            }

            await loadFollowStats();
        }

        async function sendFriendRequest(userId) {
            if (!currentUser) return;

            // Ïù¥ÎØ∏ ÏπúÍµ¨ ÏöîÏ≤≠Ïù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
            const { data: existing } = await sb
                .from('friendships')
                .select('*')
                .or(`and(user1_id.eq.${currentUser.id},user2_id.eq.${userId}),and(user1_id.eq.${userId},user2_id.eq.${currentUser.id})`)
                .single();

            if (existing) {
                if (existing.status === 'pending') {
                    showNotification('Friend request already sent!');
                } else if (existing.status === 'accepted') {
                    showNotification('Already friends!');
                }
                return;
            }

            // ÏπúÍµ¨ ÏöîÏ≤≠ Î≥¥ÎÇ¥Í∏∞
            await sb.from('friendships').insert([{
                user1_id: currentUser.id,
                user2_id: userId,
                status: 'pending'
            }]);

            showNotification('Friend request sent! ü§ù');
        }

        async function removeFriend(userId) {
            if (!currentUser) return;

            if (!confirm('Remove this friend?')) return;

            await sb
                .from('friendships')
                .delete()
                .or(`and(user1_id.eq.${currentUser.id},user2_id.eq.${userId}),and(user1_id.eq.${userId},user2_id.eq.${currentUser.id})`);

            showNotification('Friend removed');
            showFriends();
        }

        // DM Í∏∞Îä•
        let currentConversation = null;
        let currentRecipient = null;
        let currentViewingUser = null;

        // ÏïåÎ¶º Í∏∞Îä•
        async function openNotifications() {
            if (!currentUser) {
                showNotification('Please log in first!');
                openModal('loginModal');
                return;
            }

            await loadNotifications();
            openModal('notificationsModal');
        }

        async function loadNotifications() {
            if (!currentUser) return;

            console.log('Loading notifications for user:', currentUser.id);

            // ÏπúÍµ¨ ÏöîÏ≤≠ Í∞ÄÏ†∏Ïò§Í∏∞ - Î™®Îì† pending ÏöîÏ≤≠ Î®ºÏ†Ä ÌôïÏù∏
            const { data: allRequests, error: allError } = await sb
                .from('friendships')
                .select('*, user1:profiles!friendships_user1_id_fkey(username), user2:profiles!friendships_user2_id_fkey(username)')
                .eq('status', 'pending');

            console.log('All pending requests:', allRequests, 'Error:', allError);

            // ÎÇ¥Í∞Ä user2Ïù∏ ÏöîÏ≤≠Îßå ÌïÑÌÑ∞ÎßÅ (ÎÇ¥Í∞Ä Î∞õÏùÄ ÏöîÏ≤≠)
            const myRequests = allRequests?.filter(req => req.user2_id === currentUser.id) || [];

            console.log('My requests (user2):', myRequests);

            const notificationsList = document.getElementById('notificationsList');

            if (myRequests.length === 0) {
                notificationsList.innerHTML = '<p style="text-align: center; color: #8b949e; padding: 40px;">No notifications</p>';
                
                // ÏïåÎ¶º Î±ÉÏßÄ Ï†úÍ±∞
                document.getElementById('notificationBtn').innerHTML = 'üîî';
                return;
            }

            notificationsList.innerHTML = myRequests.map(req => {
                const requester = req.user1; // user1Ïù¥ Ìï≠ÏÉÅ ÏöîÏ≤≠Ïûê (ÏûëÏùÄ UUID)
                console.log('Rendering notification:', req);
                return `
                    <div style="background: rgba(124, 58, 237, 0.1); border: 1px solid #7c3aed; border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 15px;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 5px;">Friend Request</div>
                                <div style="color: #8b949e; font-size: 14px;">
                                    <span style="color: #7c3aed; font-weight: 600;">${requester?.username || 'Unknown User'}</span> sent you a friend request
                                </div>
                                <div style="color: #6b7280; font-size: 11px; margin-top: 4px;">
                                    Request ID: ${req.id.substring(0, 8)}...
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; flex-shrink: 0;">
                                <button class="btn btn-primary" onclick="acceptFriendRequest('${req.id}')">Accept</button>
                                <button class="btn btn-secondary" onclick="rejectFriendRequest('${req.id}')">Reject</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // ÏïåÎ¶º Î±ÉÏßÄ ÌëúÏãú
            const notifBtn = document.getElementById('notificationBtn');
            notifBtn.style.position = 'relative';
            notifBtn.innerHTML = 'üîî<span style="position: absolute; top: 5px; right: 5px; width: 8px; height: 8px; background: #ef4444; border-radius: 50%;"></span>';
        }

        async function acceptFriendRequest(requestId) {
            await sb.from('friendships').update({ status: 'accepted' }).eq('id', requestId);
            showNotification('Friend request accepted! ü§ù');
            await loadNotifications();
        }

        async function rejectFriendRequest(requestId) {
            await sb.from('friendships').delete().eq('id', requestId);
            showNotification('Friend request rejected');
            await loadNotifications();
        }

        // Ïú†Ï†Ä Í≤ÄÏÉâ Í∏∞Îä•
        async function openUserSearch() {
            if (!currentUser) {
                showNotification('Please log in first!');
                openModal('loginModal');
                return;
            }

            openModal('userSearchModal');
            
            document.getElementById('userSearchInput').addEventListener('input', async (e) => {
                const query = e.target.value.trim();
                if (query.length < 2) {
                    document.getElementById('userSearchResults').innerHTML = '';
                    return;
                }

                const { data: users } = await sb
                    .from('profiles')
                    .select('id, username, bio')
                    .ilike('username', `%${query}%`)
                    .neq('id', currentUser.id)
                    .limit(20);

                const results = document.getElementById('userSearchResults');

                if (!users || users.length === 0) {
                    results.innerHTML = '<p style="text-align: center; color: #8b949e; padding: 20px;">No users found</p>';
                    return;
                }

                results.innerHTML = users.map(user => `
                    <div onclick="viewUserProfile('${user.id}')" style="padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='rgba(255,255,255,0.03)'">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #7c3aed, #a855f7); display: flex; align-items: center; justify-content: center; font-size: 18px;">
                                ${user.username[0].toUpperCase()}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 3px;">${user.username}</div>
                                <div style="font-size: 13px; color: #8b949e;">${user.bio || 'No bio'}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            });
        }

        // Ïú†Ï†Ä ÌîÑÎ°úÌïÑ Î≥¥Í∏∞
        async function viewUserProfile(userId) {
            closeModal('userSearchModal');
            currentViewingUser = userId;

            // ÌîÑÎ°úÌïÑ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            const { data: profile } = await sb.from('profiles').select('*').eq('id', userId).single();

            if (!profile) {
                showNotification('User not found');
                return;
            }

            document.getElementById('otherUserProfileTitle').textContent = profile.username;
            document.getElementById('otherUsername').textContent = profile.username;
            document.getElementById('otherUserBio').textContent = profile.bio || 'No bio';
            document.getElementById('otherUserAvatar').textContent = profile.username[0].toUpperCase();

            // ÌåîÎ°úÏõå/ÌåîÎ°úÏûâ Ïàò
            const { data: followers } = await sb.from('follows').select('follower_id').eq('following_id', userId);
            const { data: following } = await sb.from('follows').select('following_id').eq('follower_id', userId);

            document.getElementById('otherFollowerCount').textContent = followers?.length || 0;
            document.getElementById('otherFollowingCount').textContent = following?.length || 0;

            // Í≤åÏûÑ Ïàò
            const { data: games } = await sb.from('games').select('*').eq('user_id', userId);
            document.getElementById('otherGameCount').textContent = games?.length || 0;
            displayGames(games || [], 'otherUserGames');

            // ÌåîÎ°úÏö∞ ÏÉÅÌÉú ÌôïÏù∏
            const { data: isFollowing } = await sb
                .from('follows')
                .select('*')
                .eq('follower_id', currentUser.id)
                .eq('following_id', userId)
                .single();

            document.getElementById('followBtn').textContent = isFollowing ? 'Unfollow' : 'Follow';

            // ÏπúÍµ¨ ÏÉÅÌÉú ÌôïÏù∏
            const { data: friendship } = await sb
                .from('friendships')
                .select('*')
                .or(`and(user1_id.eq.${Math.min(currentUser.id, userId)},user2_id.eq.${Math.max(currentUser.id, userId)})`)
                .single();

            const friendBtn = document.getElementById('friendBtn');
            if (friendship) {
                if (friendship.status === 'pending') {
                    friendBtn.textContent = 'Pending';
                    friendBtn.disabled = true;
                } else if (friendship.status === 'accepted') {
                    friendBtn.textContent = 'Friends ‚úì';
                    friendBtn.disabled = true;
                }
            } else {
                friendBtn.textContent = 'Add Friend';
                friendBtn.disabled = false;
            }

            openModal('otherUserProfileModal');
        }

        async function followUser() {
            if (!currentViewingUser) return;

            const { data: existing } = await sb
                .from('follows')
                .select('*')
                .eq('follower_id', currentUser.id)
                .eq('following_id', currentViewingUser)
                .single();

            if (existing) {
                await sb.from('follows').delete().eq('id', existing.id);
                document.getElementById('followBtn').textContent = 'Follow';
                showNotification('Unfollowed');
            } else {
                await sb.from('follows').insert([{
                    follower_id: currentUser.id,
                    following_id: currentViewingUser
                }]);
                document.getElementById('followBtn').textContent = 'Unfollow';
                showNotification('Following! üë•');
            }

            // ÌåîÎ°úÏõå/ÌåîÎ°úÏûâ Ïàò Îã§Ïãú Î°úÎìú
            const { data: followers } = await sb.from('follows').select('follower_id').eq('following_id', currentViewingUser);
            const { data: following } = await sb.from('follows').select('following_id').eq('follower_id', currentViewingUser);
            
            document.getElementById('otherFollowerCount').textContent = followers?.length || 0;
            document.getElementById('otherFollowingCount').textContent = following?.length || 0;
        }

        async function sendFriendRequestToUser() {
            if (!currentViewingUser) return;

            // user1_id < user2_id Ï°∞Í±¥ ÎïåÎ¨∏Ïóê ÏûëÏùÄ Í∞íÏùÑ user1Ïóê
            const user1 = currentUser.id < currentViewingUser ? currentUser.id : currentViewingUser;
            const user2 = currentUser.id < currentViewingUser ? currentViewingUser : currentUser.id;

            console.log('Sending friend request:', { user1, user2, currentUser: currentUser.id, viewing: currentViewingUser });

            // Ïù¥ÎØ∏ ÏûàÎäîÏßÄ ÌôïÏù∏
            const { data: existing } = await sb
                .from('friendships')
                .select('*')
                .eq('user1_id', user1)
                .eq('user2_id', user2)
                .single();

            if (existing) {
                console.log('Already exists:', existing);
                showNotification('Already sent or already friends!');
                return;
            }

            const { data: newRequest, error } = await sb.from('friendships').insert([{
                user1_id: user1,
                user2_id: user2,
                status: 'pending'
            }]).select();

            console.log('Friend request result:', { data: newRequest, error });

            if (error) {
                console.error('Friend request error:', error);
                showNotification('Failed to send friend request');
            } else {
                document.getElementById('friendBtn').textContent = 'Pending';
                document.getElementById('friendBtn').disabled = true;
                showNotification('Friend request sent! ü§ù');
                
                // ÎîîÎ≤ÑÍπÖ: ÏöîÏ≤≠Ïù¥ Ï†úÎåÄÎ°ú Ï†ÄÏû•ÎêòÏóàÎäîÏßÄ ÌôïÏù∏
                const { data: verify } = await sb
                    .from('friendships')
                    .select('*')
                    .eq('user1_id', user1)
                    .eq('user2_id', user2);
                console.log('Verification:', verify);
            }
        }

        async function startDMWithUser() {
            if (!currentViewingUser) return;

            closeModal('otherUserProfileModal');
            
            const { data: profile } = await sb.from('profiles').select('username').eq('id', currentViewingUser).single();
            
            if (profile) {
                currentRecipient = { id: currentViewingUser, username: profile.username };
                await openDM();
                await openConversation(currentViewingUser, profile.username);
            }
        }

        async function openDM() {
            if (!currentUser) {
                showNotification('Please log in first!');
                openModal('loginModal');
                return;
            }

            await loadConversations();
            openModal('dmModal');
        }

        async function loadConversations() {
            // ÏµúÍ∑º Î©îÏãúÏßÄÎì§ÏùÑ Í∞ÄÏ†∏ÏôÄÏÑú ÎåÄÌôî Î™©Î°ù ÎßåÎì§Í∏∞
            const { data: messages } = await sb
                .from('messages')
                .select('*, sender:profiles!messages_sender_id_fkey(username), recipient:profiles!messages_recipient_id_fkey(username)')
                .or(`sender_id.eq.${currentUser.id},recipient_id.eq.${currentUser.id}`)
                .order('created_at', { ascending: false });

            if (!messages || messages.length === 0) {
                document.getElementById('conversationsList').innerHTML = '<p style="text-align: center; color: #8b949e; padding: 40px;">No messages yet</p>';
                return;
            }

            // ÎåÄÌôî ÏÉÅÎåÄÎ≥ÑÎ°ú Í∑∏Î£πÌôî
            const conversations = new Map();
            messages.forEach(msg => {
                const otherId = msg.sender_id === currentUser.id ? msg.recipient_id : msg.sender_id;
                const otherUser = msg.sender_id === currentUser.id ? msg.recipient : msg.sender;
                
                if (!conversations.has(otherId)) {
                    conversations.set(otherId, {
                        userId: otherId,
                        username: otherUser.username,
                        lastMessage: msg.content,
                        timestamp: msg.created_at,
                        unread: msg.recipient_id === currentUser.id && !msg.read
                    });
                }
            });

            const conversationsList = document.getElementById('conversationsList');
            conversationsList.innerHTML = Array.from(conversations.values()).map(conv => `
                <div onclick="openConversation('${conv.userId}', '${conv.username}')" style="padding: 15px; cursor: pointer; border-bottom: 1px solid #30363d; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 5px;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #7c3aed, #a855f7); display: flex; align-items: center; justify-content: center; font-size: 18px;">
                            ${conv.username[0].toUpperCase()}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 3px;">${conv.username}</div>
                            <div style="font-size: 13px; color: #8b949e; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${conv.lastMessage}
                            </div>
                        </div>
                        ${conv.unread ? '<div style="width: 8px; height: 8px; border-radius: 50%; background: #7c3aed;"></div>' : ''}
                    </div>
                </div>
            `).join('');
        }

        async function openConversation(userId, username) {
            currentRecipient = { id: userId, username: username };
            
            document.getElementById('dmHeader').style.display = 'block';
            document.getElementById('messageInputArea').style.display = 'block';
            document.getElementById('dmRecipientName').textContent = username;

            await loadMessages(userId);

            // Î©îÏãúÏßÄÎ•º ÏùΩÏùåÏúºÎ°ú ÌëúÏãú
            await sb
                .from('messages')
                .update({ read: true })
                .eq('sender_id', userId)
                .eq('recipient_id', currentUser.id);
        }

        async function loadMessages(userId) {
            const { data: messages } = await sb
                .from('messages')
                .select('*, sender:profiles!messages_sender_id_fkey(username)')
                .or(`and(sender_id.eq.${currentUser.id},recipient_id.eq.${userId}),and(sender_id.eq.${userId},recipient_id.eq.${currentUser.id})`)
                .order('created_at', { ascending: true });

            const messagesArea = document.getElementById('messagesArea');

            if (!messages || messages.length === 0) {
                messagesArea.innerHTML = '<p style="text-align: center; color: #8b949e; padding: 40px;">No messages yet. Start the conversation!</p>';
                return;
            }

            messagesArea.innerHTML = messages.map(msg => {
                const isMine = msg.sender_id === currentUser.id;
                return `
                    <div style="display: flex; ${isMine ? 'justify-content: flex-end;' : 'justify-content: flex-start;'}">
                        <div style="max-width: 70%; padding: 12px 16px; border-radius: 16px; ${isMine ? 'background: #7c3aed;' : 'background: #21262d;'}">
                            ${!isMine ? `<div style="font-size: 12px; font-weight: 600; color: #8b949e; margin-bottom: 4px;">${msg.sender.username}</div>` : ''}
                            <div>${msg.content}</div>
                            <div style="font-size: 11px; color: ${isMine ? 'rgba(255,255,255,0.7)' : '#8b949e'}; margin-top: 4px;">
                                ${new Date(msg.created_at).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Ïä§ÌÅ¨Î°§ÏùÑ Îß® ÏïÑÎûòÎ°ú
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        async function sendMessage() {
            if (!currentUser || !currentRecipient) {
                console.error('Missing user or recipient:', { currentUser, currentRecipient });
                showNotification('Please select a conversation first!');
                return;
            }

            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content) {
                showNotification('Please enter a message!');
                return;
            }

            console.log('Sending message:', {
                sender_id: currentUser.id,
                recipient_id: currentRecipient.id,
                content: content
            });

            const { data, error } = await sb.from('messages').insert([{
                sender_id: currentUser.id,
                recipient_id: currentRecipient.id,
                content: content,
                read: false
            }]).select();

            console.log('Message result:', { data, error });

            if (error) {
                showNotification('Failed to send message: ' + error.message);
                console.error('Full error:', error);
            } else {
                console.log('Message sent successfully!');
                input.value = '';
                await loadMessages(currentRecipient.id);
                await loadConversations();
                showNotification('Message sent! üí¨');
            }
        }

        // Enter ÌÇ§Î°ú Î©îÏãúÏßÄ Î≥¥ÎÇ¥Í∏∞
        document.addEventListener('DOMContentLoaded', () => {
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
        });

        async function updateProfile() {
            const username = document.getElementById('editUsername').value;
            const bio = document.getElementById('editBio').value;

            const { error } = await sb.from('profiles').update({ username, bio }).eq('id', currentUser.id);

            if (error) {
                showNotification('Update failed');
            } else {
                showNotification('Profile updated! ‚ú®');
                closeModal('editProfileModal');
                await loadUserProfile();
            }
        }

        async function searchGames(query) {
            if (!query.trim()) {
                displayGames(allGames, 'allGames');
                return;
            }

            const { data: games } = await sb.from('games').select('*').or(`title.ilike.%${query}%,description.ilike.%${query}%`);
            displayGames(games || [], 'allGames');
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function switchModal(fromModal, toModal) {
            closeModal(fromModal);
            setTimeout(() => openModal(toModal), 300);
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('hide');
                setTimeout(() => notification.remove(), 300);
            }, 2500);
        }

        init();
    </script>
</body>
</html>
